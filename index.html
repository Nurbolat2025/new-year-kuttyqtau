<!DOCTYPE html>
<html lang="kk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global 2026 Greeting</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0d47a1">
    <link rel="icon" type="image/png" href="icon-192.png">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <style>
        body {
            margin: 0; padding: 0;
            height: 100vh;
            display: flex;
            font-family: 'Segoe UI', Tahoma, sans-serif;
            overflow: hidden;
            background: #1a1a1a;
            color: white;
        }

        /* --- 1. –°–û–õ –ñ–ê“ö: –ö–ê–†–¢–ê (65%) --- */
        #map-container {
            width: 65%;
            height: 100%;
            position: relative;
        }
        #map { width: 100%; height: 100%; z-index: 1; }
        
        /* --- 2. –û“¢ –ñ–ê“ö: –ú”ò–¢–Ü–ù–î–ï–† (35%) --- */
        #sidebar {
            width: 35%;
            height: 100%;
            background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            box-shadow: -5px 0 15px rgba(0,0,0,0.5);
            z-index: 2;
            overflow-y: auto;
        }

        /* --- –ñ–û“í–ê–†“í–´ –ú”ò–ó–Ü–† --- */
        .top-controls {
            position: absolute; top: 20px; right: 20px; z-index: 1000;
            display: flex; gap: 10px;
        }
        .icon-btn {
            background: rgba(0,0,0,0.6); color: white;
            border: 1px solid rgba(255,255,255,0.3); border-radius: 50%;
            width: 40px; height: 40px; font-size: 18px; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        .lang-select {
            background: rgba(255, 255, 255, 0.9); border-radius: 20px; padding: 5px 10px;
            font-weight: bold; border: none; cursor: pointer; outline: none;
        }

        /* --- –ö–û–ù–¢–ï–ù–¢ –°–¢–ò–õ–Ü --- */
        h1 { color: #FFD700; text-shadow: 0 0 10px #FF8C00; font-size: 1.8rem; margin-bottom: 20px; text-align: center;}

        .countdown-box {
            font-family: 'Courier New', monospace;
            background: rgba(0, 255, 255, 0.1); color: #84ffff;
            padding: 10px; border-radius: 12px; margin: 10px 0;
            font-size: 1.1rem; border: 1px solid rgba(132, 255, 255, 0.3);
            text-shadow: 0 0 5px #84ffff; width: 90%; text-align: center;
        }

        .chest-wrapper { margin: 20px 0; cursor: pointer; animation: float 3s ease-in-out infinite; text-align: center;}
        .chest-icon { font-size: 80px; filter: drop-shadow(0 0 20px gold); }
        .chest-hint { font-size: 0.9rem; color: #aaa; margin-top: 10px; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

        .card-content {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px; border-radius: 20px; width: 90%;
            text-align: center; margin-bottom: 10px;
        }

        .city-name { font-size: 2rem; color: #4DD0E1; margin: 5px 0; text-shadow: 2px 2px 4px black; }
        .greeting-text { font-size: 1.1rem; line-height: 1.5; color: #fff; margin: 15px 0; }
        
        .poem-box {
            background: rgba(0, 40, 0, 0.6);
            padding: 15px; border-radius: 15px;
            margin: 15px 0; border-left: 4px solid #FFD700;
            font-style: italic; white-space: pre-line;
            color: #fffde7; font-size: 1rem; line-height: 1.6;
            text-shadow: 1px 1px 2px black;
            border: 1px solid rgba(255, 215, 0, 0.2);
        }

        input { width: 85%; padding: 12px; margin: 10px 0; border-radius: 12px; border: none; text-align: center; font-size: 16px; }
        .main-btn {
            width: 100%; padding: 12px; margin: 5px 0;
            border-radius: 12px; border: none; font-size: 16px; font-weight: bold;
            background: linear-gradient(135deg, #FFD700 0%, #FFA000 100%);
            color: #000; cursor: pointer; box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
        }
        .main-btn:active { transform: scale(0.98); }
        .share-btn { background: linear-gradient(135deg, #eee 0%, #ccc 100%); color: #333; }
        .download-btn { background: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%); color: white; }
        
        .confirm-btn { background: #4CAF50; color: white; width: 45%; margin: 5px;}
        .deny-btn { background: #F44336; color: white; width: 45%; margin: 5px;}

        .hidden { display: none !important; }
        .plane-icon { font-size: 40px; text-shadow: 0 0 10px black; transition: transform 0.5s; }

        /* –ú–æ–±–∏–ª—å–¥—ñ–∫ –∞–¥–∞–ø—Ç–∞—Ü–∏—è (–¢–µ–ª–µ—Ñ–æ–Ω–¥–∞ –∫–∞—Ä—Ç–∞ “Ø—Å—Ç—ñ–Ω–¥–µ, –º”ô—Ç—ñ–Ω –∞—Å—Ç—ã–Ω–¥–∞ –±–æ–ª–∞–¥—ã) */
        @media (max-width: 768px) {
            body { flex-direction: column; }
            #map-container { width: 100%; height: 40%; }
            #sidebar { width: 100%; height: 60%; box-shadow: 0 -5px 15px rgba(0,0,0,0.5); }
        }
    </style>
</head>
<body>

    <div id="map-container">
        <div id="map"></div>
        
        <div class="top-controls">
            <button id="musicBtn" class="icon-btn" onclick="toggleMusic()">üîá</button>
            <select id="uiLangSelect" class="lang-select" onchange="changeLanguage()">
                <option value="kk">üá∞üáø “ö–ê–ó</option>
                <option value="ru">üá∑üá∫ –†–£–°</option>
                <option value="en">üá∫üá∏ ENG</option>
                <option value="zh">üá®üá≥ CHN</option>
                <option value="es">üá™üá∏ ESP</option>
                <option value="fr">üá´üá∑ FRA</option>
                <option value="hi">üáÆüá≥ HIN</option>
                <option value="tr">üáπüá∑ TUR</option>
                <option value="ar">üá¶üá™ ARA</option>
            </select>
        </div>
    </div>

    <div id="sidebar">
        
        <div id="loginScreen" style="width: 100%; text-align: center;">
            <h1>üåô –ë–µ—Ä–µ–∫–µ–ª—ñ 2026</h1>
            <div id="loginCountdown" class="countdown-box">–ñ“Ø–∫—Ç–µ–ª—É–¥–µ...</div>
            <p id="appDesc">–ê–¥–∞–ª –Ω–∏–µ—Ç–ø–µ–Ω “õ“±—Ç—Ç—ã“õ—Ç–∞—É –∂–æ–ª–¥–∞“£—ã–∑!</p>
            
            <div id="confirmNameBlock" class="hidden" style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 15px; margin-top: 10px;">
                <p id="confirmQuestion" style="font-size: 1.1rem; margin-bottom: 10px;">–°—ñ–∑–¥—ñ“£ –∞—Ç—ã“£—ã–∑ <b id="detectedName" style="color: #FFD700;"></b> –±–∞?</p>
                <div style="display: flex; justify-content: center;">
                    <button onclick="confirmNameYes()" class="main-btn confirm-btn" id="btnYes">–ò”ô ‚úÖ</button>
                    <button onclick="confirmNameNo()" class="main-btn deny-btn" id="btnNo">–ñ–æ“õ ‚ùå</button>
                </div>
            </div>

            <div id="inputNameBlock">
                <input type="text" id="nameInput" placeholder="–ï—Å—ñ–º—ñ“£—ñ–∑...">
                <div id="errorMsg" style="color: #FF5252; display: none; font-size: 0.9em; margin-top: 5px;"></div>
                <button onclick="startJourney()" class="main-btn" id="btnStart">–ë–∞—Å—Ç–∞—É ü§≤</button>
            </div>
        </div>

        <div id="journeyScreen" class="hidden" style="width: 100%; display: flex; flex-direction: column; align-items: center;">
            
            <div id="captureArea" class="card-content">
                <div id="mainCountdown" class="countdown-box" style="width: 95%; margin: 0 auto 10px auto;"></div>

                <div id="chestWrapper" class="chest-wrapper" onclick="openChest()">
                    <div class="chest-icon">üéÅ</div>
                    <div class="chest-hint" id="chestHint">–°—ã–π–ª—ã“õ—Ç—ã –∞—à—É “Ø—à—ñ–Ω –±–∞—Å—ã“£—ã–∑!</div>
                </div>

                <div id="contentWrapper" class="hidden">
                    <h2 id="cityName" class="city-name">City</h2>
                    <div id="greetingMsg" class="greeting-text">...</div>
                    <div id="poemBox" class="poem-box">...</div>
                </div>
            </div>
            
            <div id="controlButtons" class="hidden" style="width: 100%;">
                <button onclick="downloadCard()" class="main-btn download-btn" id="btnDownload">üì∏ –°—É—Ä–µ—Ç —Ä–µ—Ç—ñ–Ω–¥–µ –∂“Ø–∫—Ç–µ—É</button>
                <button onclick="nextCity()" class="main-btn" id="btnNext">–ö–µ–ª–µ—Å—ñ –µ–ª ‚úàÔ∏è</button>
                <button onclick="shareGreeting()" class="main-btn share-btn" id="btnShare">–ë”©–ª—ñ—Å—É üîó</button>
            </div>
        </div>

        <div style="margin-top: 20px; opacity: 0.7;">
            <a href="https://info.flagcounter.com/YourNewID" target="_blank">
                <img src="https://s11.flagcounter.com/count2/p2x2/bg_000000/txt_FFFFFF/border_CCCCCC/columns_4/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/percent_0/" alt="Flag Counter" border="0">
            </a>
        </div>
    </div>

    <audio id="bgMusic" loop>
        <source src="https://cdn.pixabay.com/download/audio/2022/10/25/audio_1f23348651.mp3" type="audio/mp3">
    </audio>

    <script>
        const targetDate = new Date("January 1, 2026 00:00:00").getTime();

        // --- –ê–£–î–ê–†–ú–ê–õ–ê–† ---
        const translations = {
            kk: {
                ui: { title: "–ë–µ—Ä–µ–∫–µ–ª—ñ 2026 –ñ—ã–ª", desc: "–ê—Ç—ã“£—ã–∑–¥—ã –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑:", ph: "–ê—Ç—ã“£—ã–∑...", start: "–ë–∞—Å—Ç–∞—É ü§≤", next: "–ö–µ–ª–µ—Å—ñ –µ–ª ‚úàÔ∏è", share: "–ë”©–ª—ñ—Å—É üîó", download: "üì∏ –û—Ç–∫—Ä—ã—Ç–∫–∞ –∂“Ø–∫—Ç–µ—É", hint: "–°—ã–π–ª—ã“õ—Ç—ã –∞—à—É “Ø—à—ñ–Ω –±–∞—Å—ã“£—ã–∑! üéÅ", days: "–∫“Ø–Ω", hours: "—Å–∞“ì", mins: "–º–∏–Ω", secs: "—Å–µ–∫", err_char: "–ê—Ç—Ç–∞ “õ–∞—Ç–µ –±–∞—Ä (—Å–∞–Ω/–±–µ–ª–≥—ñ).", err_rep: "”ò—Ä—ñ–ø –∫”©–ø “õ–∞–π—Ç–∞–ª–∞–Ω–¥—ã.", conf_q: "–°—ñ–∑–¥—ñ“£ –∞—Ç—ã“£—ã–∑ {name} –±–∞?", yes: "–ò”ô ‚úÖ", no: "–ñ–æ“õ ‚ùå" },
                coming: { greet: "“ö“±—Ä–º–µ—Ç—Ç—ñ {name}, –∫–µ–ª–µ –∂–∞—Ç“õ–∞–Ω –ñ–∞“£–∞ –∂—ã–ª–¥–∞ –ê–ª–ª–∞ –¢–∞“ì–∞–ª–∞ –µ–∫—ñ –¥“Ø–Ω–∏–µ–Ω—ñ“£ –∂–∞“õ—Å—ã–ª—ã“ì—ã–Ω –Ω”ô—Å—ñ–ø –µ—Ç—Å—ñ–Ω!", poem: "–ê–ª–ª–∞ “õ–æ–ª–¥–∞–ø ”ô—Ä —ñ—Å—ñ“£–¥—ñ –æ“£ “õ—ã–ª—Å—ã–Ω,\n–†–∏–∑—ã“õ-–Ω–µ—Å—ñ–±–µ“£ –∞–¥–∞–ª—ã–Ω–∞–Ω –º–æ–ª –±–æ–ª—Å—ã–Ω.\n–ö–µ–ª–µ –∂–∞—Ç“õ–∞–Ω –∂—ã–ª–¥–∞ –±”ô—Ä—ñ –∂–∞“£–∞—Ä—ã–ø,\n–ò–º–∞–Ω—ã“£—ã–∑ –Ω“±—Ä“ì–∞ —Ç–æ–ª–∞—Ä –∂—ã–ª –±–æ–ª—Å—ã–Ω!" },
                arrived: { greet: "“ö“±—Ä–º–µ—Ç—Ç—ñ {name}, –∫–µ–ª—ñ–ø –∂–µ—Ç–∫–µ–Ω –ñ–∞“£–∞ –∂—ã–ª–¥–∞ –ê–ª–ª–∞ –¢–∞“ì–∞–ª–∞ ”ô—Ä–±—ñ—Ä –∫“Ø–Ω—ñ“£—ñ–∑–≥–µ –±–µ—Ä–µ–∫–µ –±–µ—Ä—Å—ñ–Ω!", poem: "–ñ–∞“£–∞ –∂—ã–ª–¥–∞ –∂–∞“õ—Å—ã–ª—ã“õ—Ç–∞—Ä –∫”©–ø –±–æ–ª—Å—ã–Ω,\n–£–∞–π—ã–º-“õ–∞–π“ì—ã –µ—à“õ–∞—à–∞–Ω–¥–∞ –∂–æ“õ –±–æ–ª—Å—ã–Ω.\n–ê–ª–ª–∞ –±–µ—Ä–≥–µ–Ω “ì“±–º—ã—Ä—ã“£—ã–∑ –º”ô–Ω–¥—ñ –±–æ–ø,\n–î–∞—Å—Ç–∞—Ä—Ö–∞–Ω—ã“£ –∞–¥–∞–ª –∞—Å“õ–∞ –ª—ã“õ —Ç–æ–ª—Å—ã–Ω!" }
            },
            ru: {
                ui: { title: "–ë–ª–∞–≥–æ—Å–ª–æ–≤–µ–Ω–Ω—ã–π 2026", desc: "–í–≤–µ–¥–∏—Ç–µ –∏–º—è:", ph: "–í–∞—à–µ –∏–º—è...", start: "–û—Ç–∫—Ä—ã—Ç—å ü§≤", next: "–°–ª–µ–¥. —Å—Ç—Ä–∞–Ω–∞ ‚úàÔ∏è", share: "–ü–æ–¥–µ–ª–∏—Ç—å—Å—è üîó", download: "üì∏ –°–∫–∞—á–∞—Ç—å", hint: "–ù–∞–∂–º–∏—Ç–µ —Å—É–Ω–¥—É–∫! üéÅ", days: "–¥–Ω", hours: "—á", mins: "–º", secs: "—Å", err_char: "–û—à–∏–±–∫–∞ –≤ –∏–º–µ–Ω–∏.", err_rep: "–ü–æ–≤—Ç–æ—Ä –±—É–∫–≤.", conf_q: "–í–∞—Å –∑–æ–≤—É—Ç {name}?", yes: "–î–∞ ‚úÖ", no: "–ù–µ—Ç ‚ùå" },
                coming: { greet: "–£–≤–∞–∂–∞–µ–º—ã–π(–∞—è) {name}, –≤ –Ω–∞—Å—Ç—É–ø–∞—é—â–µ–º –≥–æ–¥—É –ø—É—Å—Ç—å –í—Å–µ–≤—ã—à–Ω–∏–π –¥–∞—Ä—É–µ—Ç –≤–∞–º –±–ª–∞–≥–æ–ø–æ–ª—É—á–∏–µ!", poem: "–ü—É—Å—Ç—å –ê–ª–ª–∞—Ö —Ö—Ä–∞–Ω–∏—Ç –æ—Ç –±–µ–¥,\n–î–∞—Ä–∏—Ç –º—É–¥—Ä–æ—Å—Ç—å –∏ —Å–æ–≤–µ—Ç.\n–í –Ω–∞—Å—Ç—É–ø–∞—é—â–µ–º –≥–æ–¥—É,\n–û—Ç–≤–æ–¥–∏—Ç –≥–æ—Ä–µ –∏ –±–µ–¥—É." },
                arrived: { greet: "–£–≤–∞–∂–∞–µ–º—ã–π(–∞—è) {name}, –≤ –Ω–∞—Å—Ç—É–ø–∏–≤—à–µ–º –≥–æ–¥—É –ø—É—Å—Ç—å –í—Å–µ–≤—ã—à–Ω–∏–π –Ω–∞–ø–æ–ª–Ω–∏—Ç –≤–∞—à –¥–æ–º –±–∞—Ä–∞–∫–∞—Ç–æ–º!", poem: "–ì–æ–¥ –ø—Ä–∏—à–µ–ª, —Ö–≤–∞–ª–∞ –¢–≤–æ—Ä—Ü—É,\n–°—á–∞—Å—Ç—å–µ –ø—É—Å—Ç—å –ø—Ä–∏–¥–µ—Ç –∫ –ª–∏—Ü—É.\n–ú–∏—Ä, –ø–æ–∫–æ–π –∏ –±–ª–∞–≥–æ–¥–∞—Ç—å,\n–ë—É–¥—É—Ç –¥–æ–º –≤–∞—à –Ω–∞–ø–æ–ª–Ω—è—Ç—å." }
            },
            en: {
                ui: { title: "Blessed 2026", desc: "Enter name:", ph: "Name...", start: "Start ü§≤", next: "Next ‚úàÔ∏è", share: "Share üîó", download: "üì∏ Save Card", hint: "Tap chest! üéÅ", days: "d", hours: "h", mins: "m", secs: "s", err_char: "Invalid name.", err_rep: "Repeated chars.", conf_q: "Is your name {name}?", yes: "Yes ‚úÖ", no: "No ‚ùå" },
                coming: { greet: "Dear {name}, may the Almighty grant you success and halal sustenance!", poem: "May Allah guide you day by day,\nKeep all troubles far away.\nIn the coming year so new,\nMay His blessings be with you." },
                arrived: { greet: "Dear {name}, may the Almighty fill your life with peace and faith!", poem: "New year is here, bright and clear,\nMay faith in heart be ever near.\nGoodness, health, and halal wealth,\nJoy and peace and spiritual health." }
            },
            zh: { ui: { title: "ÂêâÁ•• 2026", desc: "ËæìÂÖ•ÂêçÂ≠ó:", ph: "ÂêçÂ≠ó...", start: "ÂºÄÂßã ü§≤", next: "‰∏ã‰∏Ä‰∏™", share: "ÂàÜ‰∫´", download: "üì∏ ‰∏ãËΩΩ", hint: "ÁÇπÂáªÂÆùÁÆ±!", days: "Â§©", hours: "Êó∂", mins: "ÂàÜ", secs: "Áßí", err_char: "ÂêçÂ≠óÊúâËØØ„ÄÇ", err_rep: "ÈáçÂ§çÂ≠óÁ¨¶„ÄÇ", conf_q: "ÊÇ®Âè´ {name} ÂêóÔºü", yes: "ÊòØ", no: "‰∏ç" }, coming: { greet: "‰∫≤Áà±ÁöÑ {name}ÔºåÊÑøÁúü‰∏ªËµêÁ¶èÔºÅ", poem: "ÊÑøÁúü‰∏ªËµêÁ¶èÊñ∞‰∏ÄÂπ¥Ôºå\nÂπ≥ÂÆâÂñú‰πêÂ∏∏Áõ∏‰º¥„ÄÇ\nÊ≠£ÈÅìÂÖâËäíÁÖßÂøÉÈó¥Ôºå\nÁîüÊ¥ªÁæéÊª°Á¶èÊó†Ëæπ„ÄÇ" }, arrived: { greet: "‰∫≤Áà±ÁöÑ {name}ÔºåÊñ∞Âπ¥Âø´‰πêÔºÅ", poem: "Êñ∞Âπ¥Â∑≤Ëá≥ÂñúÊ∞îÊµìÔºå\nÂøÉ‰∏≠‰ø°‰ª∞Êó∂ÂàªÂêå„ÄÇ\nÂÅ•Â∫∑Ë¥¢ÂØåÊ∫êÂêàÊ≥ïÔºå\nÂπ∏Á¶èÂÆâÂ∫∑‰º¥‰∏ÄÁîü„ÄÇ" } },
            es: { ui: { title: "Bendito 2026", desc: "Nombre:", ph: "Nombre...", start: "Empezar", next: "Siguiente", share: "Compartir", download: "üì∏ Descargar", hint: "¬°Toca el cofre!", days: "d", hours: "h", mins: "m", secs: "s", err_char: "Error nombre.", err_rep: "Repetici√≥n.", conf_q: "¬øEres {name}?", yes: "S√≠", no: "No" }, coming: { greet: "Querido/a {name}, ¬°que Al√° te bendiga!", poem: "Que Allah gu√≠e tu caminar,\nY te aleje de todo mal.\nEn este a√±o que va a empezar,\nMucha paz te va a regalar." }, arrived: { greet: "Querido/a {name}, ¬°feliz a√±o nuevo!", poem: "El a√±o nuevo ya lleg√≥,\nLa fe en el alma floreci√≥.\nSalud y paz en tu hogar,\nBendiciones sin cesar." } },
            fr: { ui: { title: "B√©ni 2026", desc: "Nom:", ph: "Nom...", start: "Commencer", next: "Suivant", share: "Partager", download: "üì∏ T√©l√©charger", hint: "Appuyez coffre!", days: "j", hours: "h", mins: "m", secs: "s", err_char: "Erreur nom.", err_rep: "R√©p√©tition.", conf_q: "Est-ce vous, {name}?", yes: "Oui", no: "Non" }, coming: { greet: "Cher {name}, qu'Allah vous b√©nisse !", poem: "Qu'Allah √©claire votre chemin,\nEt vous prot√®ge chaque matin.\nQue cette ann√©e soit un festin,\nDe paix et d'amour sans fin." }, arrived: { greet: "Cher {name}, bonne ann√©e !", poem: "Le nouvel an est arriv√©,\nQue votre foi soit pr√©serv√©e.\nBonheur, sant√© et puret√©,\nPour toute l'√©ternit√©." } },
            hi: { ui: { title: "Mubarak 2026", desc: "Naam:", ph: "Naam...", start: "Shuru", next: "Agla", share: "Share", download: "üì∏ Save", hint: "Sandook kholein!", days: "d", hours: "h", mins: "m", secs: "s", err_char: "Naam ghalti.", err_rep: "Repeat.", conf_q: "Kya aap {name} hain?", yes: "Haan", no: "Nahi" }, coming: { greet: "Pyare {name}, Allah aap par rehmat kare!", poem: "Allah ki rehmat barse aap par,\nKhushiyon se bhar jaye ghar.\nHar mushkil ho jaye aasan,\nNaye saal mein mile sukoon-o-aman." }, arrived: { greet: "Pyare {name}, naya saal mubarak!", poem: "Naya saal aaya hai roshan hokar,\nDil mein iman rahe hamesha jagmagakar.\nAcchai, sehat aur halal kamai,\nKhushi aur aman ki ho bharpayi." } },
            tr: { ui: { title: "Bereketli 2026", desc: "Adƒ±nƒ±z:", ph: "Adƒ±nƒ±z...", start: "Ba≈üla", next: "Sonraki", share: "Payla≈ü", download: "üì∏ ƒ∞ndir", hint: "Sandƒ±ƒüa tƒ±kla!", days: "g", hours: "s", mins: "dk", secs: "sn", err_char: "ƒ∞sim hatalƒ±.", err_rep: "Tekrar.", conf_q: "Adƒ±nƒ±z {name} mƒ±?", yes: "Evet", no: "Hayƒ±r" }, coming: { greet: "Sevgili {name}, Allah razƒ± olsun!", poem: "Rabbim yolunu a√ßƒ±k etsin,\nHer t√ºrl√º dertten seni korusun.\nYeni yƒ±lda t√ºm dualarƒ±n,\nHayƒ±rlƒ±sƒ±yla kabul olsun." }, arrived: { greet: "Sevgili {name}, yeni yƒ±lƒ±nƒ±z m√ºbarek olsun!", poem: "Yeni yƒ±l geldi ho≈ü geldi,\nG√∂nl√ºne iman dolsun ebedi.\nRabbimden dilerim saadet,\nHayatƒ±n olsun hep selamet." } },
            ar: { ui: { title: "ÿπÿßŸÖ ŸÖÿ®ÿßÿ±ŸÉ 2026", desc: "ÿßŸÑÿßÿ≥ŸÖ:", ph: "ÿßŸÑÿßÿ≥ŸÖ...", start: "ÿßÿ®ÿØÿ£", next: "ÿßŸÑÿ™ÿßŸÑŸä", share: "ŸÖÿ¥ÿßÿ±ŸÉÿ©", download: "üì∏ ÿ™ÿ≠ŸÖŸäŸÑ", hint: "ÿßÿ∂ÿ∫ÿ∑ ÿßŸÑÿµŸÜÿØŸàŸÇ!", days: "Ÿä", hours: "ÿ≥", mins: "ÿØ", secs: "ÿ´", err_char: "ÿÆÿ∑ÿ£ ÿßŸÑÿßÿ≥ŸÖ.", err_rep: "ÿ™ŸÉÿ±ÿßÿ±.", conf_q: "ŸáŸÑ ÿ£ŸÜÿ™ {name}ÿü", yes: "ŸÜÿπŸÖ", no: "ŸÑÿß" }, coming: { greet: "ÿπÿ≤Ÿäÿ≤Ÿä {name}ÿå ÿ®ÿßÿ±ŸÉ ÿßŸÑŸÑŸá ŸÅŸäŸÉ!", poem: "Ÿäÿß ÿ±ÿ® ÿ®ÿßÿ±ŸÉ ŸÅŸä ÿßŸÑÿπÿßŸÖ ÿßŸÑÿ¨ÿØŸäÿØÿå\nŸàÿßÿ¨ÿπŸÑ ÿ≠Ÿäÿßÿ© {name} ŸÅŸä ÿπŸäÿØ.\nÿ®ÿßŸÑÿ•ŸäŸÖÿßŸÜ ŸàÿßŸÑÿ™ŸÇŸàŸâ ÿ™ÿ≤ŸäÿØÿå\nŸàÿ±ÿ∂ÿß ÿßŸÑÿ±ÿ≠ŸÖŸÜ ŸáŸà ÿßŸÑŸÖÿ≤ŸäÿØ." }, arrived: { greet: "ÿπÿ≤Ÿäÿ≤Ÿä {name}ÿå ÿπÿßŸÖ ÿ≥ÿπŸäÿØ!", poem: "ÿπÿßŸÖ ÿ¨ÿØŸäÿØ ÿ£ŸÇÿ®ŸÑ ÿπŸÑŸäŸÜÿßÿå\nŸÜÿ≥ÿ£ŸÑ ÿßŸÑŸÑŸá ÿßŸÑŸÑÿ∑ŸÅ ŸÅŸäŸÜÿß.\nÿßÿ±ÿ≤ŸÇŸÜÿß Ÿäÿß ÿ±ÿ® ÿßŸÑÿ¨ŸÜÿßŸÜÿå\nŸàÿßÿ≠ŸÅÿ∏ŸÜÿß ŸÖŸÜ ŸÉŸÑ ÿ¥Ÿäÿ∑ÿßŸÜ." } }
        };

        const destinations = [
            { name: "Astana üá∞üáø", coords: [51.16, 71.47], lang: "kk" },
            { name: "Beijing üá®üá≥", coords: [39.90, 116.40], lang: "zh" },
            { name: "Mecca üá∏üá¶", coords: [21.38, 39.85], lang: "ar" },
            { name: "Istanbul üáπüá∑", coords: [41.00, 28.97], lang: "tr" },
            { name: "London üá¨üáß", coords: [51.50, -0.12], lang: "en" },
            { name: "Madrid üá™üá∏", coords: [40.41, -3.70], lang: "es" },
            { name: "Paris üá´üá∑", coords: [48.85, 2.35], lang: "fr" },
            { name: "New Delhi üáÆüá≥", coords: [28.61, 77.20], lang: "hi" },
            { name: "Tashkent üá∫üáø", coords: [41.29, 69.24], lang: "ru" }
        ];

        let map, planeMarker, flightLine;
        let currentDestIndex = 0;
        let userName = "–î–æ—Å—ã–º";
        let isMusicPlaying = false;
        const audio = document.getElementById('bgMusic');

        window.onload = () => {
            initMap();
            setInterval(updateCountdown, 1000);
            updateCountdown(); 
            
            const urlParams = new URLSearchParams(window.location.search);
            const sharedName = urlParams.get('name');

            if (sharedName) {
                document.getElementById('confirmNameBlock').classList.remove('hidden');
                document.getElementById('inputNameBlock').classList.add('hidden');
                document.getElementById('detectedName').textContent = sharedName;
                userName = sharedName;
            }
            changeLanguage();
        };

        function initMap() {
            // –ö–∞—Ä—Ç–∞–Ω—ã –æ—Ä—Ç–∞“ì–∞ “õ–æ—è–º—ã–∑
            map = L.map('map', { zoomControl: false }).setView([30, 0], 2);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { attribution: '', subdomains: 'abcd', maxZoom: 19 }).addTo(map);
            
            // “∞—à–∞“õ –±–µ–ª–≥—ñ—Å—ñ
            const planeIcon = L.divIcon({ html: '<div style="font-size: 40px; transform: rotate(0deg);">‚úàÔ∏è</div>', className: 'plane-icon', iconSize: [40, 40], iconAnchor: [20, 20] });
            planeMarker = L.marker([51.16, 71.47], {icon: planeIcon}).addTo(map);
        }

        // --- –í–ê–õ–ò–î–ê–¶–ò–Ø ---
        function validateName(name) {
            const invalidChars = /[0-9!@#$%^&*()_+={}\[\]|\\:;"'<>,.?/~`]/;
            if (invalidChars.test(name)) return "char";
            if (/(.)\1{3,}/.test(name)) return "repeat";
            return "ok";
        }

        function startJourney() {
            const inputVal = document.getElementById('nameInput').value.trim();
            const lang = document.getElementById('uiLangSelect').value;
            const t = translations[lang].ui;
            const errorDiv = document.getElementById('errorMsg');

            if (!inputVal) { userName = "–î–æ—Å—ã–º"; } 
            else {
                const status = validateName(inputVal);
                if (status === "char") { errorDiv.textContent = t.err_char; errorDiv.style.display = 'block'; return; }
                else if (status === "repeat") { errorDiv.textContent = t.err_rep; errorDiv.style.display = 'block'; return; }
                userName = inputVal;
            }
            errorDiv.style.display = 'none';
            proceedToJourney();
        }

        function confirmNameYes() { proceedToJourney(); }
        function confirmNameNo() {
            document.getElementById('confirmNameBlock').classList.add('hidden');
            document.getElementById('inputNameBlock').classList.remove('hidden');
            document.getElementById('nameInput').value = "";
        }

        function proceedToJourney() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('journeyScreen').classList.remove('hidden');
            
            // –ú—É–∑—ã–∫–∞–Ω—ã “õ–æ—Å—É
            if (!isMusicPlaying) {
                audio.play().then(() => { isMusicPlaying = true; document.getElementById('musicBtn').textContent = "üéµ"; })
                     .catch(e => console.log(e));
            }

            // –ë–∞—Å—Ç–∞–ø“õ—ã –Ω“Ø–∫—Ç–µ–≥–µ –±–∞—Ä—É
            const lang = document.getElementById('uiLangSelect').value;
            const cityIndex = destinations.findIndex(d => d.lang === lang);
            if(cityIndex !== -1) currentDestIndex = cityIndex;
            
            flyToCity(destinations[currentDestIndex]);
        }

        function flyToCity(city) {
            const oldLatLng = planeMarker.getLatLng();
            const newLatLng = city.coords;

            // 1. –ö–∞—Ä—Ç–∞–Ω—ã –∂—ã–ª–∂—ã—Ç—É
            map.flyTo(newLatLng, 4, { duration: 2.5 });

            // 2. “∞—à–∞“õ—Ç—ã –∂—ã–ª–∂—ã—Ç—É (–∞–Ω–∏–º–∞—Ü–∏—è –∂–æ“õ, –∫–∞—Ä—Ç–∞–º–µ–Ω –±—ñ—Ä–≥–µ –±–∞—Ä–∞–¥—ã)
            planeMarker.setLatLng(newLatLng);

            // 3. –°–´–ó–´“ö –°–´–ó–£ (Flight Path)
            if (flightLine) map.removeLayer(flightLine);
            flightLine = L.polyline([oldLatLng, newLatLng], {color: 'red', weight: 3, opacity: 0.7, dashArray: '10, 10'}).addTo(map);
        }

        function updateCountdown() {
            const now = new Date().getTime();
            const distance = targetDate - now;
            const lang = document.getElementById('uiLangSelect').value;
            const t = translations[lang].ui;

            if (distance < 0) {
                document.getElementById('loginCountdown').textContent = "üéâ 2026!";
                document.getElementById('mainCountdown').textContent = "üéâ 2026!";
            } else {
                const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                const timeStr = `‚è≥ ${days}${t.days} ${hours}${t.hours} ${minutes}${t.mins} ${seconds}${t.secs}`;
                document.getElementById('loginCountdown').textContent = timeStr;
                document.getElementById('mainCountdown').textContent = timeStr;
            }
        }

        function changeLanguage() {
            const lang = document.getElementById('uiLangSelect').value;
            const t = translations[lang].ui;

            document.querySelector('#loginScreen h1').textContent = t.title;
            document.getElementById('appDesc').textContent = t.desc;
            document.getElementById('nameInput').placeholder = t.ph;
            document.getElementById('btnStart').textContent = t.start;
            document.getElementById('chestHint').textContent = t.hint;
            document.getElementById('confirmQuestion').innerHTML = t.conf_q.replace("{name}", `<b style="color:#FFD700">${userName}</b>`);
            document.getElementById('btnYes').textContent = t.yes;
            document.getElementById('btnNo').textContent = t.no;

            if (!document.getElementById('contentWrapper').classList.contains('hidden')) {
                updateCardContent();
            }
        }

        function toggleMusic() {
            if (isMusicPlaying) { audio.pause(); isMusicPlaying = false; document.getElementById('musicBtn').textContent = "üîá"; } 
            else { audio.play(); isMusicPlaying = true; document.getElementById('musicBtn').textContent = "üéµ"; }
        }

        function openChest() {
            confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 }, shapes: ['circle'], colors: ['#FFD700', '#FF0000', '#00FF00'] });
            const scalar = 3;
            const emojis = confetti.shapeFromText({ text: 'üê¥', scalar });
            const flowers = confetti.shapeFromText({ text: 'üå∏', scalar });
            confetti({ particleCount: 15, scalar: 3, spread: 100, origin: { y: 0.7 }, shapes: [emojis, flowers] });

            document.getElementById('chestWrapper').style.display = 'none';
            document.getElementById('contentWrapper').classList.remove('hidden');
            document.getElementById('controlButtons').classList.remove('hidden');
            updateCardContent();
        }

        function updateCardContent() {
            const city = destinations[currentDestIndex];
            const langCode = city.lang;
            document.getElementById('uiLangSelect').value = langCode;
            
            const t = translations[langCode];
            const now = new Date().getTime();
            const data = (now >= targetDate) ? t.arrived : t.coming;

            document.getElementById('cityName').textContent = city.name;
            document.getElementById('greetingMsg').innerHTML = data.greet.replace("{name}", `<b style="color:#FFD700">${userName}</b>`);
            document.getElementById('poemBox').textContent = data.poem;
            
            document.getElementById('btnNext').textContent = t.ui.next;
            document.getElementById('btnShare').textContent = t.ui.share;
            document.getElementById('btnDownload').textContent = t.ui.download;
        }

        function nextCity() {
            currentDestIndex = (currentDestIndex + 1) % destinations.length;
            const city = destinations[currentDestIndex];
            flyToCity(city);
            updateCardContent();
        }

        function shareGreeting() {
            const url = window.location.href.split('?')[0] + "?name=" + encodeURIComponent(userName);
            if (navigator.share) { navigator.share({ title: '2026 Wish', url: url }); } 
            else { navigator.clipboard.writeText(url); alert("Copied!"); }
        }

        function downloadCard() {
            const captureElement = document.getElementById('captureArea');
            captureElement.style.background = "linear-gradient(135deg, #0f2027, #203a43, #2c5364)"; // –°—É—Ä–µ—Ç–∫–µ ”ô–¥–µ–º—ñ —Ñ–æ–Ω –±–µ—Ä—É
            html2canvas(captureElement, { backgroundColor: null, scale: 2 }).then(canvas => {
                captureElement.style.background = ""; // “ö–∞–ª–ø—ã–Ω–∞ –∫–µ–ª—Ç—ñ—Ä—É
                const link = document.createElement('a');
                link.download = 'NewYear2026_Greeting.png';
                link.href = canvas.toDataURL();
                link.click();
            });
        }
    </script>
</body>
</html>
